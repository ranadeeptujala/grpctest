# Sequence Diagrams

## 1. Unary RPC - SayHello

```
┌────────┐          ┌──────────────────┐          ┌───────────────┐          ┌─────────────────┐
│ Client │          │ GreetingController│          │ GrpcClient    │          │ GreetingService │
└───┬────┘          └────────┬─────────┘          └───────┬───────┘          └────────┬────────┘
    │                        │                            │                           │
    │  GET /hello?name=John  │                            │                           │
    │───────────────────────>│                            │                           │
    │                        │                            │                           │
    │                        │  sayHello("John", "en")    │                           │
    │                        │───────────────────────────>│                           │
    │                        │                            │                           │
    │                        │                            │  gRPC: SayHello(request)  │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │        [Virtual Thread]   │
    │                        │                            │        Process Request    │
    │                        │                            │                           │
    │                        │                            │  HelloResponse            │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │  HelloResponse             │                           │
    │                        │<───────────────────────────│                           │
    │                        │                            │                           │
    │  JSON Response         │                            │                           │
    │<───────────────────────│                            │                           │
    │                        │                            │                           │
```

## 2. Server Streaming RPC - SayHelloStream

```
┌────────┐          ┌──────────────────┐          ┌───────────────┐          ┌─────────────────┐
│ Client │          │ GreetingController│          │ GrpcClient    │          │ GreetingService │
└───┬────┘          └────────┬─────────┘          └───────┬───────┘          └────────┬────────┘
    │                        │                            │                           │
    │  GET /hello-stream     │                            │                           │
    │───────────────────────>│                            │                           │
    │                        │                            │                           │
    │                        │  sayHelloStream("John")    │                           │
    │                        │───────────────────────────>│                           │
    │                        │                            │                           │
    │                        │                            │  gRPC: SayHelloStream     │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  Response 1: "Hello"      │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  Response 2: "Hola"       │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  Response 3: "Bonjour"    │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  ... more responses ...   │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  [Stream Complete]        │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │  List<HelloResponse>       │                           │
    │                        │<───────────────────────────│                           │
    │                        │                            │                           │
    │  JSON Array Response   │                            │                           │
    │<───────────────────────│                            │                           │
    │                        │                            │                           │
```

## 3. Client Streaming RPC - SayHelloToMany

```
┌────────┐          ┌──────────────────┐          ┌───────────────┐          ┌─────────────────┐
│ Client │          │ GreetingController│          │ GrpcClient    │          │ GreetingService │
└───┬────┘          └────────┬─────────┘          └───────┬───────┘          └────────┬────────┘
    │                        │                            │                           │
    │  POST /hello-many      │                            │                           │
    │  ["Alice","Bob","Eve"] │                            │                           │
    │───────────────────────>│                            │                           │
    │                        │                            │                           │
    │                        │  sayHelloToMany(names)     │                           │
    │                        │───────────────────────────>│                           │
    │                        │                            │                           │
    │                        │                            │  Request 1: "Alice"       │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  Request 2: "Bob"         │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  Request 3: "Eve"         │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  [Stream Complete]        │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │        [Aggregate all]    │
    │                        │                            │                           │
    │                        │                            │  HelloResponse            │
    │                        │                            │  "Hello: Alice,Bob,Eve!"  │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │  HelloResponse             │                           │
    │                        │<───────────────────────────│                           │
    │                        │                            │                           │
    │  JSON Response         │                            │                           │
    │<───────────────────────│                            │                           │
    │                        │                            │                           │
```

## 4. Bidirectional Streaming RPC - SayHelloBidirectional

```
┌────────┐          ┌──────────────────┐          ┌───────────────┐          ┌─────────────────┐
│ Client │          │ GreetingController│          │ GrpcClient    │          │ GreetingService │
└───┬────┘          └────────┬─────────┘          └───────┬───────┘          └────────┬────────┘
    │                        │                            │                           │
    │  POST /hello-bidi      │                            │                           │
    │  ["Alice","Bob"]       │                            │                           │
    │───────────────────────>│                            │                           │
    │                        │                            │                           │
    │                        │  sayHelloBidirectional()   │                           │
    │                        │───────────────────────────>│                           │
    │                        │                            │                           │
    │                        │                            │  Request: "Alice"         │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  Response: "Hello,Alice!" │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  Request: "Bob"           │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  Response: "Hello, Bob!"  │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │                            │  [Client Complete]        │
    │                        │                            │──────────────────────────>│
    │                        │                            │                           │
    │                        │                            │  [Server Complete]        │
    │                        │                            │<──────────────────────────│
    │                        │                            │                           │
    │                        │  List<HelloResponse>       │                           │
    │                        │<───────────────────────────│                           │
    │                        │                            │                           │
    │  JSON Array Response   │                            │                           │
    │<───────────────────────│                            │                           │
    │                        │                            │                           │
```

## 5. Virtual Thread Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           Virtual Thread Lifecycle                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  Time ──────────────────────────────────────────────────────────────────────────────►   │
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │                        Request Processing                                         │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  Virtual Thread:                                                                        │
│  ┌───────────┐   ┌─────────────────────────────────────┐   ┌──────────────────────┐    │
│  │  Created  │──>│  Mounted on Carrier Thread          │──>│  Processing Request  │    │
│  └───────────┘   └─────────────────────────────────────┘   └──────────┬───────────┘    │
│                                                                        │                 │
│                                                                        ▼                 │
│                                                             ┌──────────────────────┐    │
│                                                             │  Blocking I/O Call   │    │
│                                                             │  (DB, HTTP, etc.)    │    │
│                                                             └──────────┬───────────┘    │
│                                                                        │                 │
│                                                                        ▼                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            UNMOUNTED                                             │   │
│  │                    (Carrier thread is FREE)                                      │   │
│  │                                                                                  │   │
│  │    Carrier Thread ──────────► Can execute OTHER virtual threads                 │   │
│  │                                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                        │                 │
│                                            I/O completes ──────────────┘                │
│                                                                        │                 │
│                                                                        ▼                 │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐ │
│  │  Re-mounted on Carrier Thread (may be different carrier)                          │ │
│  └───────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                        │                 │
│                                                                        ▼                 │
│                                                             ┌──────────────────────┐    │
│                                                             │  Continue Processing │    │
│                                                             └──────────┬───────────┘    │
│                                                                        │                 │
│                                                                        ▼                 │
│                                                             ┌──────────────────────┐    │
│                                                             │  Return Response     │    │
│                                                             │  Thread Terminated   │    │
│                                                             └──────────────────────┘    │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. gRPC vs REST Communication

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            REST (HTTP/1.1)                                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  Client                                                  Server                          │
│  ──────                                                  ──────                          │
│                                                                                          │
│  Request 1  ═══════════════════════════════════════════►                                │
│             ◄═══════════════════════════════════════════  Response 1                    │
│                                                                                          │
│  Request 2  ═══════════════════════════════════════════►  (New connection or wait)      │
│             ◄═══════════════════════════════════════════  Response 2                    │
│                                                                                          │
│  • One request per connection (or connection reuse with keep-alive)                     │
│  • Head-of-line blocking                                                                 │
│  • Text-based (JSON) - larger payload                                                   │
│  • New TCP handshake overhead                                                           │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            gRPC (HTTP/2)                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  Client                                                  Server                          │
│  ──────                                                  ──────                          │
│                                                                                          │
│         ╔══════════════════ Single Connection ═══════════════════════╗                  │
│         ║                                                            ║                  │
│         ║  Stream 1: Request ─────────────────────────────────────►  ║                  │
│         ║            ◄───────────────────────────────── Response     ║                  │
│         ║                                                            ║                  │
│         ║  Stream 2: Request ─────────────────────────────────────►  ║ (Parallel!)     │
│         ║            ◄───────────────────────────────── Response     ║                  │
│         ║                                                            ║                  │
│         ║  Stream 3: Request ─────────────────────────────────────►  ║                  │
│         ║            ◄───────────────────────────────── Response     ║                  │
│         ║                                                            ║                  │
│         ╚════════════════════════════════════════════════════════════╝                  │
│                                                                                          │
│  • Multiple streams over single connection (multiplexing)                               │
│  • No head-of-line blocking                                                             │
│  • Binary (Protocol Buffers) - smaller payload                                          │
│  • Single TCP connection, reused                                                        │
│  • Header compression (HPACK)                                                           │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 7. AWS ALB Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                          AWS ALB Request Flow                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  External User (REST API)                                                               │
│  ─────────────────────────                                                              │
│                                                                                          │
│  ┌────────────┐     HTTPS:443    ┌────────────────┐    HTTP:8080    ┌──────────────┐   │
│  │   User     │ ─────────────────►│  Public ALB    │ ───────────────►│   App        │   │
│  │  (Browser) │                  │  (Internet)    │                 │  (Fargate)   │   │
│  └────────────┘                  └────────────────┘                 └──────────────┘   │
│                                         │                                               │
│                                         │ TLS Termination                              │
│                                         │ Target Group Health Check: /health           │
│                                         │                                               │
│                                                                                          │
│  Internal Service (gRPC)                                                                │
│  ───────────────────────                                                                │
│                                                                                          │
│  ┌────────────┐    HTTPS:443     ┌────────────────┐   HTTP/2:9090   ┌──────────────┐   │
│  │  Other     │ ─────────────────►│  Internal ALB  │ ───────────────►│   App        │   │
│  │  Service   │     gRPC         │  (VPC only)    │      gRPC      │  (Fargate)   │   │
│  └────────────┘                  └────────────────┘                 └──────────────┘   │
│                                         │                                               │
│                                         │ gRPC Health Check:                           │
│                                         │ /grpc.health.v1.Health/Check                 │
│                                         │ Success codes: 0-99                          │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 8. Health Check Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Health Check Flow                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌───────────────────┐                                                                  │
│  │     AWS ALB       │                                                                  │
│  │  Target Group     │                                                                  │
│  └─────────┬─────────┘                                                                  │
│            │                                                                             │
│            │  Every 30 seconds                                                          │
│            │                                                                             │
│            ▼                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Application                                           │ │
│  │                                                                                    │ │
│  │  REST Health (Port 8080)                 gRPC Health (Port 9090)                  │ │
│  │  ──────────────────────                  ─────────────────────────                │ │
│  │                                                                                    │ │
│  │  GET /health                             grpc.health.v1.Health/Check              │ │
│  │       │                                         │                                  │ │
│  │       ▼                                         ▼                                  │ │
│  │  ┌─────────────┐                         ┌─────────────────────┐                  │ │
│  │  │HealthController│                         │ gRPC Health Service │                  │ │
│  │  └──────┬──────┘                         └──────────┬──────────┘                  │ │
│  │         │                                           │                              │ │
│  │         ▼                                           ▼                              │ │
│  │  Response: 200 OK                         Response: Status = SERVING              │ │
│  │  {                                        (gRPC status code: 0)                   │ │
│  │    "status": "UP"                                                                 │ │
│  │  }                                                                                │ │
│  │                                                                                    │ │
│  └───────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  Health Check Results:                                                                  │
│  ─────────────────────                                                                  │
│                                                                                          │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐                   │
│  │    Healthy      │     │   Unhealthy     │     │    Draining     │                   │
│  │                 │     │                 │     │                 │                   │
│  │  2+ consecutive │     │  3+ consecutive │     │  Deregistering  │                   │
│  │  200 responses  │     │  non-200        │     │  (connection    │                   │
│  │                 │     │  responses      │     │   draining)     │                   │
│  └─────────────────┘     └─────────────────┘     └─────────────────┘                   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

